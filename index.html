<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Co-Pilot PRO - Sprint 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .chat-container {
        height: 60vh;
        overflow-y: auto;
        scroll-behavior: smooth;
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <div class="max-w-4xl mx-auto py-8 px-4">
      <header
        class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4"
      >
        <div>
          <h1 class="text-3xl font-bold text-blue-400">
            AI Co-Pilot
            <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded"
              >PRO</span
            >
          </h1>
          <p class="text-gray-400 text-sm">RAG Assistant + Telemetry Enabled</p>
        </div>
        <div class="flex gap-2">
          <a
            href="http://127.0.0.1:8000/api/metrics"
            class="text-xs bg-green-900/30 hover:bg-green-900/50 text-green-300 border border-green-700 px-3 py-2 rounded transition"
            >Download KPIs</a
          >
          <button
            onclick="clearChat()"
            class="text-xs bg-red-900/30 hover:bg-red-900/50 text-red-300 border border-red-700 px-3 py-2 rounded transition"
          >
            Clear Memory
          </button>
        </div>
      </header>

      <div
        id="chatBox"
        class="chat-container bg-gray-800/50 rounded-xl p-6 mb-6 space-y-4 shadow-2xl border border-gray-700"
      >
        <div
          class="bg-blue-900/20 border border-blue-800 p-3 rounded-lg text-blue-200 text-sm"
        >
          <b>System:</b> Metrics and Feedback loop active. How can I help with
          your code today?
        </div>
      </div>

      <div class="relative">
        <input
          type="text"
          id="userInput"
          onkeypress="if(event.key==='Enter') sendMsg()"
          placeholder="Type your query..."
          class="w-full bg-gray-800 border border-gray-600 rounded-xl px-5 py-4 focus:outline-none focus:border-blue-500 shadow-lg text-lg"
        />
        <button
          onclick="sendMsg()"
          class="absolute right-3 top-3 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg font-bold transition"
        >
          Send
        </button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chatBox");
      const input = document.getElementById("userInput");

      function appendMessage(role, text, latency = null) {
        const isAI = role === "AI";
        const feedbackHtml = isAI
          ? `
                <div class="flex gap-2 mt-2">
                    <button onclick="this.disabled=true; alert('Feedback saved!')" class="text-xs bg-gray-600 hover:bg-green-600 px-2 py-1 rounded">üëç</button>
                    <button onclick="this.disabled=true; alert('Feedback saved!')" class="text-xs bg-gray-600 hover:bg-red-600 px-2 py-1 rounded">üëé</button>
                    <span class="text-[10px] text-gray-400 self-center">${
                      latency ? latency + "ms" : ""
                    }</span>
                </div>`
          : "";

        const msgHtml = `
                <div class="flex ${
                  isAI ? "justify-start" : "justify-end"
                } animate-fade-in mb-4">
                    <div class="${
                      isAI
                        ? "bg-gray-700 text-blue-100"
                        : "bg-blue-600 text-white"
                    } max-w-[85%] px-4 py-3 rounded-2xl shadow-md">
                        <p class="text-xs font-bold mb-1 opacity-70">${role}</p>
                        <p class="text-md leading-relaxed">${text}</p>
                        ${feedbackHtml}
                    </div>
                </div>`;
        chatBox.innerHTML += msgHtml;
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function sendMsg() {
        const query = input.value.trim();
        if (!query) return;

        appendMessage("You", query);
        input.value = "";

        try {
          const response = await fetch("http://127.0.0.1:8000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });
          const data = await response.json();
          appendMessage("AI", data.response, data.latency_ms);
        } catch (error) {
          appendMessage("System", "‚ùå Error: Backend unreachable.");
        }
      }

      function clearChat() {
        chatBox.innerHTML =
          '<div class="text-center text-gray-500 text-xs py-2">History cleared</div>';
      }
    </script>
  </body>
</html>
